# All rights reserved.
#
# This is free software, licensed under the GNU General Public License v2.
# See /LICENSE for more information.

include $(TOPDIR)/rules.mk
include $(INCLUDE_DIR)/kernel.mk

PKG_NAME:=mt7663e
PKG_VERSION:=5.1.0.0
P4REV:=8

PKG_BUILD_DIR:=$(KERNEL_BUILD_DIR)/$(PKG_NAME)
PKG_KCONFIG:= \
	SUPPORT_OPENWRT \
	DEFAULTS_KERNEL_4_4 \
	SUPPORT_OPENWRT \
	CHIP_MT7663E \
	RT_FIRST_CARD \
	RT_FIRST_IF_RF_OFFSET \
	RT_SECOND_CARD \
	RT_SECOND_IF_RF_OFFSET \
	RT_THIRD_CARD \
	RT_THIRD_IF_RF_OFFSET \
	FIRST_IF_EEPROM_PROM \
	FIRST_IF_EEPROM_EFUSE \
	FIRST_IF_EEPROM_FLASH \
	SECOND_IF_EEPROM_PROM \
	SECOND_IF_EEPROM_EFUSE \
	SECOND_IF_EEPROM_FLASH \
	THIRD_IF_EEPROM_PROM \
	THIRD_IF_EEPROM_EFUSE \
	THIRD_IF_EEPROM_FLASH \
	MT_AP_SUPPORT \
	MTK_EMI_7622 \
	DEFAULT_5G_PROFILE \
	COEX_SUPPORT \
	NEW_RATE_ADAPT_SUPPORT \
	RATE_ADAPT_AGBS_SUPPORT \
	UAPSD \
	MT_MAC \
	WSC_INCLUDED \
	DUSER_GOAHEAD_HTTP \
	USER_LIGHTY \
	MT_AP_SUPPORT \
	MT_STA_SUPPORT \
	WSC_V2_SUPPORT \
	DOT11_VHT_AC \
	WFA_VHT_R2_PF \
	DOT11_HE_AX \
	WAPI_SUPPORT \
	RALINK_RT3052 \
	WPA3_SUPPORT \
	OWE_SUPPORT \
	WMM_ACM_SUPPORT \
	MT_MAC \
	DOT11W_PMF_SUPPORT \
	LLTD_SUPPORT \
	DOT11K_RRM_SUPPORT \
	KVRH_SUPPORT \
	TPC_SUPPORT \
	THERMAL_PROTECT_SUPPORT \
	FTM_SUPPORT \
	PASSPOINT_R2 \
	WNM_SUPPORT \
	DSCP_PRI_SUPPORT \
	INTERWORKING \
	MBO_SUPPORT \
	OCE_SUPPORT \
	MAP_SUPPORT \
	WAPP \
	TRACE_TCP_PKT \
	BACKGROUND_SCAN_SUPPORT \
	MT_DFS_SUPPORT \
	WIFI_EAP_FEATURE \
	VLAN_SUPPORT \
	WIFI_GPIO_CTRL \
	MIN_PHY_RATE_SUPPORT \
	DOT11R_FT_SUPPORT \
	MBO_SUPPORT \
	RT2860V2_80211K_RR \
	SNIFFER_SUPPORT \
	VENDOR_FEATURE11_SUPPORT \
	ANTENNA_CONTROL_SUPPORT \
	MGMT_TXPWR_CTRL \
	TXD_MGMT_TXPWR_CTRL \
	CHUTIL_SUPPORT \
	NF_SUPPORT \
	TXRX_STAT_SUPPORT \
	RA_PHY_RATE_SUPPORT \
	AMPDU_CONF_SUPPORT \
	ACK_CTS_TIMEOUT_SUPPORT \
	ENTERPRISE_AP_SUPPORT \
	VLAN_SUPPORT \
	RADIUS_MAC_AUTH_SUPPORT \
	DYNAMIC_VLAN_SUPPORT \
	CFG80211_SUPPORT \
	HOSTAPD_MAP_SUPPORT \
	CUSTOMISED_HOSTAPD_SUPPORT \
	WDS_STA_SUPPORT \
	HOSTAPD_MAP_SUPPORT \
	APCLI_STA_SUPPORT \
	HOSTAPD_MAP_SUPPORT \
	AUTOMATION \
	RALINK_TIMER_WDG \
	OFFCHANNEL_SCAN_FEATURE \
	MTK_WD_KICKER \
	MTK_WD_KICKER_WCN \
	IGMP_SNOOP_SUPPORT \
	BLOCK_NET_IF \
	SINGLE_SKU \
	RT2860V2_AP_VIDEO_TURBINE \
	SMART_CARRIER_SENSE_SUPPORT \
	SCS_FW_OFFLOAD \
	MBSS_SUPPORT \
	NEW_MBSSID_MODE \
	ENHANCE_NEW_MBSSID_MODE \
	MBSS_AS_WDS_AP_SUPPORT \
	WDS_SUPPORT \
	APCLI_SUPPORT \
	APCLI_CONNECTION_TRIAL \
	CFG80211_SUPPORT \
	MAC_REPEATER_SUPPORT \
	IDS_SUPPORT \
	NINTENDO_AP \
	COC_SUPPORT \
	GREENAP_SUPPORT \
	PCIE_ASPM_DYM_CTRL_SUPPORT \
	ATE_SUPPORT \
	ICAP_SUPPORT \
	SPECTRUM_SUPPORT \
	RTMP_FLASH_SUPPORT \
	PRE_CAL_TRX_SET1_SUPPORT \
	RLM_CAL_CACHE_SUPPORT \
	PRE_CAL_TRX_SET2_SUPPORT \
	CAL_BIN_FILE_SUPPORT \
	RF_LOCKDOWN_SUPPORT \
	LINK_TEST_SUPPORT \
	RTMP_TEMPERATURE_TX_ALC \
	TXBF_SUPPORT \
	MUMIMO_SUPPORT \
	MU_RA_SUPPORT \
	FALCON_MURU_SUPPORT \
	CON_WPS_SUPPORT \
	MULTI_INF_SUPPORT \
	RT2860V2_AP_CARRIER \
	MCAST_RATE_SPECIFIC \
	AIRPLAY_SUPPORT \
	BAND_STEERING \
	AIR_MONITOR \
	EASY_SETUP_SUPPORT \
	MWDS \
	EVENT_NOTIFIER_SUPPORT \
	VOW_SUPPORT \
	RED_SUPPORT \
	FQ_SCH_SUPPORT \
	CUSTOMER_VENDOR_IE_SUPPORT \
	MT76XX_COMBO_DUAL_DRIVER_SUPPORT \
	WLAN_HOOK \
	MULTI_INF_SUPPORT \
	WIFI_WORK_QUEUE_BH \
	KTHREAD \
	LINUX_NET_TXQ_SUPPORT \
	SECOND_IF_MT7637E \
	ATE_SUPPORT \
	DBDC_MODE \
	MT76XX_COMBO_DUAL_DRIVER_SUPPORT \
	CHIP_MT7615E \
	G_BAND_256QAM_SUPPORT \
	BRCM_256QAM_SUPPORT \
	HDR_TRANS_TX_SUPPORT \
	HDR_TRANS_RX_SUPPORT \
	RATE_ADAPT_AGBS_SUPPORT \
	TCP_RACK_SUPPORT \
	LED_CONTROL_SUPPORT \
	WSC_INCLUDED \
	RADIUS_ACCOUNTING_SUPPORT \
	ATE_SUPPORT \
	FDB_SUPPORT \
	CHIP_MT7663E \
	MT_DFS_SUPPORT \
	CUSTOMER_RSG_FEATURE \
	CUSTOMER_DCC_FEATURE \
	AUTOMATION \
	PROPRIETARY_DRIVER \
	PRE_CAL_SUPPORT \
	PRE_CAL_SUPPORT \
	G_BAND_256QAM_SUPPORT \
	BRCM_256QAM_SUPPORT \
	OCE_SUPPORT \
	HDR_TRANS_TX_SUPPORT \
	HDR_TRANS_RX_SUPPORT \
	RATE_ADAPT_AGBS_SUPPORT \
	TCP_RACK_SUPPORT \
	LED_CONTROL_SUPPORT \
	WSC_INCLUDED \
	RADIUS_ACCOUNTING_SUPPORT \
	ATE_SUPPORT \
	FDB_SUPPORT \
	MT7663_RFB_MANUAL_CAL \
	FTM_SUPPORT \
	FIRST_IF_MT7626 \
	FIRST_IF_MT7603E \
	SUPPORT_OPENWRT \
	7626_USE_PCI \
	MEMORY_SHRINK \
	RPS_EFFICIENCY \
	AUTOMATION \
	PROPRIETARY_DRIVER \
	PRE_CAL_SUPPORT \
	G_BAND_256QAM_SUPPORT \
	BRCM_256QAM_SUPPORT \
	HDR_TRANS_TX_SUPPORT \
	HDR_TRANS_RX_SUPPORT \
	RATE_ADAPT_AGBS_SUPPORT \
	TCP_RACK_SUPPORT \
	LED_CONTROL_SUPPORT \
	WSC_INCLUDED \
	RADIUS_ACCOUNTING_SUPPORT \
	ATE_SUPPORT \
	FDB_SUPPORT \
	SUPPORT_OPENWRT \
	7626_USE_PCI \
	FIRST_IF_MT7622 \
	PROPRIETARY_DRIVER \
	PLATFORM_DRV_SUPPROT \
	HDR_TRANS_TX_SUPPORT \
	HDR_TRANS_RX_SUPPORT \
	VHT_TXBF_2G_EPIGRAM_IE_SUPPORT \
	RATE_ADAPT_AGBS_SUPPORT \
	ATE_SUPPORT \
	CHIP_AXE \
	G_BAND_256QAM_SUPPORT \
	BRCM_256QAM_SUPPORT \
	HDR_TRANS_TX_SUPPORT \
	HDR_TRANS_RX_SUPPORT \
	RATE_ADAPT_AGBS_SUPPORT \
	TCP_RACK_SUPPORT \
	LED_CONTROL_SUPPORT \
	WSC_INCLUDED \
	RADIUS_ACCOUNTING_SUPPORT \
	ATE_SUPPORT \
	FDB_SUPPORT \
	RTMP_FLASH_SUPPORT \
	MTD \
	SUPPORT_OPENWRT \
	MTD_SPI_NOR \
	MTD_NAND \
	DEFAULTS_KERNEL_4_4 \
	MTD_SPI_NOR \
	MTD_NAND \
	DEFAULTS_MEDIATEK_MT7622 \
	PLATFORM_DRV_SUPPORT \
	FW_LOG_DUMP_SUPPORT \
	ATE_SUPPORT \
	TCP_RACK_SUPPORT \
	RT2860V2_AUTO_CH_SELECT_ENCANCE \
	RT2860V2_SNMP \
	RT2860V2_AP_32B_DESC \
	RT2860V2_HW_ANTENNA_DIVERSITY \
	RT2860V2_EXT_CHANNEL_LIST \
	MEMORY_OPTIMIZATION \
	RTMP_INTERNAL_TX_ALC \
	RALINK_MT7621 \
	FAST_NAT_SUPPORT \
	WLAN_HOOK \
	WHNAT_SUPPORT \
	WHNAT_SUPPORT \
	EASY_SETUP_SUPPORT \
	MWDS \
	EVENT_NOTIFIER_SUPPORT \
	CFG80211_SUPPORT \
	WIFI_FWD_SUPPORT \
	MTFWD_SUPPORT \
	ROAMING_ENHANCE_SUPPORT \
	IXIA_SUPPORT \
	CHIP_MT7663E \
	CHIP_MT7603E \
	MT_WIFI

PKG_CONFIG_DEPENDS:=$(foreach c, $(PKG_KCONFIG),$(if $(CONFIG_MTK_MT7663E_$c),CONFIG_$(c)))

include $(INCLUDE_DIR)/package.mk

TAR_CMD=$(HOST_TAR) -C $(1)/ $(TAR_OPTIONS)

define KernelPackage/mt7663e
  CATEGORY:=Kernel modules
  TITLE:=MTK wifi AP driver
  DEPENDS:=@TARGET_ramips +mt7663-scripts +wifi-l1profile +wifi_services +@KERNEL_WIRELESS_EXT
ifneq ($(CONFIG_MTK_WHNAT_SUPPORT),)
  FILES:=$(PKG_BUILD_DIR)/mt_wifi_ap/mt_wifi.ko \
	$(PKG_BUILD_DIR)/mt_wifi/embedded/plug_in/whnat/mt_whnat.ko
else
  FILES:=$(PKG_BUILD_DIR)/mt_wifi_ap/mt_wifi.ko
endif
  SUBMENU:=Wireless Drivers
  MENU:=1
endef

define KernelPackage/mt7663e/config
	source "$(SOURCE)/config.in"
endef

define Package/mt7663-scripts
  CATEGORY:=MTK Properties
  SUBMENU:=Drivers
  TITLE:=mt7663 scripts
  DEPENDS:=
  HIDDEN:=1
endef

define Build/Compile
	$(MAKE) -C "$(LINUX_DIR)" V=1 \
		CROSS_COMPILE="$(TARGET_CROSS)" \
		ARCH="$(LINUX_KARCH)" \
		M="$(PKG_BUILD_DIR)/mt_wifi_ap" \
		$(foreach c, $(PKG_KCONFIG),$(if $(CONFIG_MTK_MT7663E_$c),CONFIG_$(c)=$(CONFIG_MTK_MT7663E_$(c)))) \
		modules
endef

define KernelPackage/mt7663e/install
	$(INSTALL_DIR) $(1)/etc/wireless/mt7663
endef

define Package/mt7663-scripts/install
	$(INSTALL_DIR) $(1)/lib/wifi/
	$(INSTALL_DIR) $(1)/etc/wireless/mt7663/
	$(INSTALL_DIR) $(1)/lib/firmware/
	-if [ "$$(CONFIG_WIFI_SCRIPT_LUA)" = "y" ]; then \
	$(INSTALL_BIN) ./files/mt7663.lua $(1)/lib/wifi/; \
	else \
	$(INSTALL_BIN) ./files/mt7663.sh $(1)/lib/wifi/; \
	fi
	echo $(PKG_VERSION) > $(1)/etc/wireless/mt7663/version

	if [ "$$(CONFIG_MTK_MT7663E_FIRST_IF_MT7663E)" = "y" ]; then \
		$(INSTALL_BIN) ./files/mt7663-sku.dat $(1)/etc/wireless/mt7663/; \
		$(INSTALL_BIN) ./files/mt7663-sku-bf.dat $(1)/etc/wireless/mt7663/; \
		if [ "$$(CONFIG_PACKAGE_libmapd)" = "y" ]; then \
			$(INSTALL_BIN) ./files/mt7663.1.map.dat $(1)/etc/wireless/mt7663/mt7663.1.dat; \
		else \
			$(INSTALL_BIN) ./files/mt7663.1.dat $(1)/etc/wireless/mt7663/; \
		fi \
	fi

	if [ "$$(CONFIG_MTK_MT7663E_SECOND_IF_MT7663E)" = "y" ]; then \
		$(INSTALL_BIN) ./files/mt7663-sku.dat $(1)/etc/wireless/mt7663/; \
		$(INSTALL_BIN) ./files/mt7663-sku-bf.dat $(1)/etc/wireless/mt7663/; \
		if [ "$$(CONFIG_PACKAGE_libmapd)" = "y" ]; then \
			$(INSTALL_BIN) ./files/mt7663.2.map.dat $(1)/etc/wireless/mt7663/mt7663.2.dat; \
		else \
			$(INSTALL_BIN) ./files/mt7663.2.dat $(1)/etc/wireless/mt7663/; \
		fi \
	fi
endef

$(eval $(call KernelPackage,mt7663e))
$(eval $(call BuildPackage,mt7663-scripts))
